{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aos.local/schemas/ws_patch.v2.1.schema.json",
  "title": "WorkingSetPatchV2_1",
  "type": "object",
  "additionalProperties": false,
  "required": ["_schema_version", "expected_seq", "set"],
  "properties": {
    "_schema_version": {"type": "string", "const": "2.1"},
    "expected_seq": {"type": "integer", "minimum": 0},
    "set": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "status": {
          "type": "string",
          "enum": ["BOOT", "IDLE", "BUSY", "WAITING_INPUT", "PAUSED", "DONE", "FAILED"]
        },
        "acceptance_criteria": {
          "type": "array",
          "items": {"type": "string"}
        },
        "current_stage": {"type": "string", "minLength": 1},
        "next_action": {"type": "string"},
        "constraints": {
          "type": "array",
          "items": {"type": "string"}
        },
        "artifact_refs": {
          "type": "array",
          "items": {"$ref": "#/$defs/artifact_ref"}
        },
        "blockers": {
          "type": "array",
          "items": {"type": "string"}
        },
        "last_action_summary": {"type": "string"},
        "pinned_context": {
          "type": "array",
          "maxItems": 10,
          "items": {"$ref": "#/$defs/pinned_context_item"}
        },
        "sliding_context": {
          "type": "array",
          "items": {"$ref": "#/$defs/sliding_context_item"}
        }
      }
    }
  },
  "$defs": {
    "artifact_ref": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "id"],
      "properties": {
        "type": {"type": "string", "minLength": 1},
        "id": {"type": "string", "minLength": 1},
        "path": {"type": "string"},
        "sha256": {"type": "string", "pattern": "^[0-9a-fA-F]{64}$"}
      }
    },
    "pinned_context_item": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "content"],
      "properties": {
        "id": {"type": "string", "minLength": 1},
        "content": {"type": "string", "minLength": 1},
        "source_ref": {"type": "string"}
      }
    },
    "sliding_context_item": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "content", "timestamp", "priority"],
      "properties": {
        "id": {"type": "string", "minLength": 1},
        "content": {"type": "string", "minLength": 1},
        "timestamp": {"type": "string", "format": "date-time"},
        "priority": {"type": "integer", "minimum": 0, "maximum": 9}
      }
    }
  }
}
